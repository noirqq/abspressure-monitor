# Система Мониторинга Атмосферного Давления для Home Assistant с Уведомлениями в Telegram

Эта система для Home Assistant предназначена для отслеживания изменений атмосферного давления. Она позволяет пользователю:
- Получать по запросу через Telegram детальный анализ изменения давления за выбранный период.
- Автоматически получать уведомления в Telegram при обнаружении резких колебаний давления, превышающих настраиваемый порог.

## Функционал

- **Ручной анализ по команде `/trend`**: Отправьте команду `/trend <часы>` вашему Telegram-боту (например, `/trend 3`), чтобы получить отчет об изменении давления за указанное количество часов. Отчет включает начальное, конечное, минимальное, максимальное, среднее давление и среднюю скорость изменения.
- **Запрос текущего давления по команде `/pressure`**: Быстрое получение текущего значения давления.
- **Автоматические уведомления**: Система периодически проверяет скорость изменения давления. Если скорость превышает установленный порог (например, 5 гПа/час), отправляется уведомление в Telegram.
- **Настраиваемые параметры**: Порог срабатывания для автоматических уведомлений, окно анализа и время "кулдауна" (период тишины после уведомления) настраиваются через вспомогательные элементы (Input Helpers) в интерфейсе Home Assistant.
- **Форматированные сообщения**: Уведомления и отчеты в Telegram используют Markdown для лучшей читаемости.

## Требования

Для полноценной работы системы необходимы следующие компоненты в вашем Home Assistant:

**Дополнения (Add-ons):**
- **InfluxDB**: Для хранения исторических данных о давлении.
- **Studio Code Server** или **File editor**: Для удобного редактирования конфигурационных файлов и Pyscript-кода.

**Интеграции Home Assistant:**
- **HACS (Home Assistant Community Store)**: Рекомендуется для простой установки Pyscript.
- **Pyscript Python scripting**: Для выполнения основной логики системы.
- **InfluxDB (интеграция)**: Для связи Home Assistant с базой данных InfluxDB и выполнения запросов (требует работающий сервис `influxdb.query`).
- **Telegram bot**: Для приема команд и отправки сообщений.
- **Notify (платформа Telegram)**: Для создания сервиса уведомлений.
- **Источник данных о давлении**: Любой сенсор атмосферного давления, интегрированный в Home Assistant (например, `sensor.openweathermap_pressure`).
- **Input Number**: Для создания настраиваемых числовых порогов и параметров.
- **Input Datetime**: Для отслеживания времени последнего уведомления (кулдаун).
- **Automation**: Для определения триггеров и вызова Pyscript-сервисов.

## Установка и Настройка

1.  **Убедитесь, что все [Требования](#требования) выполнены**: Все необходимые дополнения и интеграции должны быть установлены и корректно настроены в вашем Home Assistant. Особенно важна работоспособность интеграции InfluxDB и доступность сервиса `influxdb.query`.

2.  **Pyscript Модуль**:
    *   Скопируйте файл `pyscript/pressure_monitor.py` из этого репозитория в вашу папку `config/pyscript/` (или `config/pyscript/apps/`) вашего Home Assistant.
    *   **Отредактируйте конфигурационные переменные** в начале файла `pressure_monitor.py`, особенно:
        *   `SENSOR_ID`: Укажите точный ID вашего сенсора давления.
        *   `TELEGRAM_AUTO_ALERT_CHAT_ID`: **Обязательно замените** на ваш реальный Chat ID для получения автоматических уведомлений.
        *   Проверьте остальные параметры (`INFLUXDB_MEASUREMENT`, `INFLUXDB_FIELD`, `TELEGRAM_NOTIFIER_SERVICE`, `AUTO_ALERT_COOLDOWN_MINUTES` и ID хелперов), чтобы они соответствовали вашей системе.

3.  **Конфигурация Home Assistant (`configuration.yaml`)**:
    *   Скопируйте содержимое файла `home_assistant_config/configuration_snippet.yaml` из этого репозитория и добавьте/объедините его с вашим основным файлом `configuration.yaml`.
    *   **ВАЖНО**: Замените все значения-заглушки (например, `YOUR_TELEGRAM_BOT_API_KEY`, `YOUR_CHAT_ID`, учетные данные для InfluxDB) вашими реальными данными. **Никогда не выкладывайте реальные API-ключи и пароли в публичные репозитории!**
    *   Убедитесь, что у вас есть строка `automation: !include automations.yaml` (или аналогичная) для подключения файла автоматизаций.

4.  **Автоматизации (`automations.yaml`)**:
    *   Скопируйте содержимое файла `home_assistant_config/automations_snippet.yaml` из этого репозитория и добавьте его в ваш файл `automations.yaml`.

5.  **Перезагрузка и Настройка**:
    *   После внесения изменений в `configuration.yaml`, **полностью перезапустите Home Assistant**.
    *   После перезапуска настройте начальные значения для созданных вспомогательных элементов (`input_number.auto_pressure_alert_threshold` и `input_number.auto_pressure_check_window_hours`) через интерфейс Home Assistant (Настройки -> Устройства и службы -> вкладка "Объекты", или добавьте их на вашу Lovelace панель).
    *   После добавления/изменения `automations.yaml`, перезагрузите автоматизации (Панель разработчика -> YAML -> Автоматизации -> Перезагрузить).
    *   После добавления/изменения Pyscript-файла (`pressure_monitor.py`), вызовите сервис `pyscript.reload` (Панель разработчика -> Сервисы).

## Использование

-   **Получить текущее давление**: Отправьте команду `/pressure` вашему Telegram-боту.
-   **Получить анализ тренда**: Отправьте команду `/trend <N>` вашему боту, где `<N>` - количество часов для анализа (например, `/trend 2`).
-   **Автоматические уведомления**: Будут приходить в чат, указанный в `TELEGRAM_AUTO_ALERT_CHAT_ID` в Pyscript-файле, если скорость изменения давления превысит установленный порог, и кулдаун не будет активен.

## Устранение неполадок

-   **Ошибка "Service influxdb.query not found"**: Наиболее частая проблема.
    1.  Убедитесь, что интеграция `influxdb` в `configuration.yaml` настроена правильно (хост, порт, база, логин, пароль).
    2.  Home Assistant должен быть **полностью перезапущен** после настройки `influxdb`.
    3.  Проверьте логи запуска Home Assistant на наличие ошибок, связанных с `influxdb`. Включите debug-логирование для `homeassistant.components.influxdb` в секции `logger` вашего `configuration.yaml` для более детальной информации.
    4.  Убедитесь, что ваш сервер InfluxDB запущен и доступен для Home Assistant.
-   **Ошибка "Service pyscript... not found"**:
    1.  Проверьте логи Home Assistant на наличие ошибок Python в вашем Pyscript-файле (`pressure_monitor.py`).
    2.  Убедитесь, что Pyscript перезагружен (`pyscript.reload`) после изменений в файле.
    3.  Проверьте точность имен сервисов в `automations.yaml` и в Pyscript-файле (после `@service def`).
-   **Нет данных от InfluxDB (сообщение "Нет данных..." или "Недостаточно данных...")**:
    1.  Убедитесь, что ваш сенсор давления (`SENSOR_ID` в Pyscript) правильно указан в `include.entities` секции `influxdb` в `configuration.yaml`.
    2.  Проверьте, что данные от этого сенсора действительно записываются в InfluxDB и присутствуют за запрашиваемый период.
    3.  Проверьте правильность `INFLUXDB_MEASUREMENT` и `INFLUXDB_FIELD` в Pyscript.
